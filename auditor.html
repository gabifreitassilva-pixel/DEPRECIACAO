<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Fiscal Digital Pro - Auditoria Reversa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #000000; color: #ffffff; font-family: 'Inter', sans-serif; }
        .dashboard-card { background-color: #0a0a0a; border: 1px solid #222; transition: all 0.3s ease; }
        .dashboard-card:hover { border-color: #FF8C00; }
        .orange-accent { color: #FF8C00; }
        .orange-border-top { border-top: 4px solid #FF8C00; }
        .orange-border-left { border-left: 4px solid #FF8C00; }
        .btn-orange { background-color: #FF8C00; color: #000; font-weight: 900; text-transform: uppercase; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-orange:hover:not(:disabled) { background-color: #ff9d26; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4); }
        .btn-orange:disabled { background-color: #333; color: #666; cursor: not-allowed; }
        input[readonly] { background-color: #111 !important; color: #ccc !important; border-color: #222 !important; }
        .table-container { max-height: 550px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF8C00; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-black text-white p-6 border-b border-zinc-800 shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-orange-500 p-2 rounded-lg shadow-[0_0_15px_rgba(255,140,0,0.4)]">
                    <i class="fas fa-file-invoice-dollar text-black text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter uppercase italic">Auditor <span class="orange-accent">Fiscal</span></h1>
                    <p class="text-[10px] opacity-60 uppercase tracking-[0.3em]">IA de NCM e Auditoria Reversa</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="index.html" class="px-4 py-2 border border-zinc-700 rounded-lg text-xs font-bold hover:bg-zinc-900 transition flex items-center gap-2 uppercase">
                    <i class="fas fa-home"></i> Início
                </a>
                <a href="histórico.html" class="px-4 py-2 border border-orange-500/30 rounded-lg text-xs font-bold hover:bg-orange-500/10 transition flex items-center gap-2 uppercase orange-accent">
                    <i class="fas fa-database"></i> Ver Histórico
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4 flex-1">
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="dashboard-card p-6 rounded-xl orange-border-top shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-id-card orange-accent"></i>Dados Identificados</h2>
                <div class="space-y-3">
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase">Empresa</label><input type="text" id="input-company" readonly class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase">Regime Tributário</label><input type="text" id="input-regime" readonly class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase">CNPJ</label><input type="text" id="input-cnpj" readonly class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase">Períodos</label><input type="text" id="input-period" readonly class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none"></div>
                </div>
            </div>

            <div class="dashboard-card p-6 rounded-xl orange-border-top flex flex-col shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-folder-open orange-accent"></i>Importar Notas (XML)</h2>
                <div class="flex-1 border-2 border-dashed border-zinc-800 rounded-lg flex flex-col items-center justify-center p-4 group hover:border-orange-500 transition cursor-pointer" onclick="document.getElementById('xml-input').click()">
                    <input type="file" id="xml-input" multiple accept=".xml" class="hidden" onchange="window.handleFileChange(event)">
                    <i class="fas fa-cloud-arrow-up text-3xl text-zinc-700 mb-2 group-hover:text-orange-500"></i>
                    <p id="upload-status" class="text-xs text-zinc-500 font-medium text-center uppercase">Selecione arquivos SAT/NFe</p>
                </div>
                <button id="btn-start" disabled onclick="window.runFullSemanticAudit()" class="btn-orange mt-4 py-4 rounded-lg flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-bolt"></i> Iniciar Auditoria</button>
            </div>

            <div class="dashboard-card p-6 rounded-xl orange-border-top shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-gears orange-accent"></i>Gerenciamento</h2>
                <div class="space-y-3">
                    <button id="btn-excel" disabled onclick="window.exportComparativeExcel()" class="w-full btn-orange py-3 rounded flex items-center justify-center gap-2"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    <button id="btn-save" disabled onclick="window.persistAuditData()" class="w-full btn-orange py-3 rounded flex items-center justify-center gap-2"><i class="fas fa-save"></i> Gravar Auditoria</button>
                    <button onclick="window.location.reload()" class="w-full border border-zinc-800 py-3 rounded text-zinc-500 font-bold hover:bg-zinc-900 transition text-xs uppercase"><i class="fas fa-eraser mr-2"></i>Nova Análise</button>
                    <div id="fb-msg" class="text-center text-[10px] font-bold mt-1 uppercase"></div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="dashboard-card p-5 rounded-xl orange-border-left shadow-lg"><p class="text-[10px] text-zinc-500 uppercase font-bold">Lote de Notas</p><h3 id="kpi-xmls" class="text-3xl font-black text-white">0</h3></div>
            <div class="dashboard-card p-5 rounded-xl orange-border-left shadow-lg"><p class="text-[10px] text-zinc-500 uppercase font-bold">Itens Auditados</p><h3 id="kpi-items" class="text-3xl font-black text-white">0</h3></div>
            <div class="dashboard-card p-5 rounded-xl border-l-4 border-red-600 shadow-lg"><p class="text-[10px] text-zinc-500 uppercase font-bold">Inconsistências</p><h3 id="kpi-errors" class="text-3xl font-black text-red-500">0%</h3></div>
            <div class="dashboard-card p-5 rounded-xl border-l-4 border-green-600 bg-green-950/10 shadow-lg"><p class="text-[10px] text-zinc-500 uppercase font-bold text-green-600">Total Recuperável</p><h3 id="kpi-recovery" class="text-3xl font-black text-green-500">R$ 0,00</h3></div>
        </section>

        <section class="dashboard-card rounded-xl overflow-hidden shadow-2xl">
            <div class="p-5 border-b border-zinc-800 bg-zinc-900/40 flex justify-between items-center">
                <h2 class="font-bold text-zinc-200 uppercase text-xs">Relatório: Original vs Sugestão</h2>
                <div id="loader" class="hidden flex items-center gap-2 text-[10px] font-bold text-orange-500 animate-pulse uppercase"><i class="fas fa-sync fa-spin"></i> Processando...</div>
            </div>
            <div class="table-container">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-black text-zinc-500 sticky top-0 z-10 border-b border-zinc-800 uppercase">
                        <tr><th class="p-4">Produto</th><th class="p-4">NCM Orig.</th><th class="p-4 text-center">Trib. Orig.</th><th class="p-4 text-center orange-accent">Sugestão</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Crédito</th></tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-zinc-900 text-zinc-300"></tbody>
                </table>
                <div id="empty-state" class="p-20 text-center text-zinc-800 opacity-20 uppercase font-bold text-sm">Aguardando Importação...</div>
            </div>
        </section>
    </main>

    <div id="completion-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-orange-500 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-black text-2xl"></i></div>
            <h3 class="text-xl font-black text-white uppercase mb-2">Concluído</h3>
            <p id="modal-desc" class="text-zinc-400 text-sm mb-6">Auditoria finalizada com sucesso.</p>
            <button onclick="document.getElementById('completion-modal').classList.add('hidden')" class="btn-orange w-full py-3 rounded-xl">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAkgh6778FzobRxLl3trFE0KQ2D9PJOYra",
            authDomain: "auditor-fiscal-pro.firebaseapp.com",
            projectId: "auditor-fiscal-pro",
            storageBucket: "auditor-fiscal-pro.firebasestorage.app",
            messagingSenderId: "901682265807",
            appId: "1:901682265807:web:0b399cf95a7213fdeec1ba",
            measurementId: "G-MZ3MTGMEJ0"
        };

        const appId = 'auditor-sp-pro-v7';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let filesQueue = [];
        let state = { xmlCount: 0, itemCount: 0, errorCount: 0, totalRecovery: 0, company: '', cnpj: '', regime: '', competences: new Set(), auditDetails: [] };

        const INTELLIGENCE_DB = [
            { keywords: ["SORVETE", "PICOLÉ"], sNCM: "2105.00.10", icmsST: true, pisMono: false, sugPIS: "07", sugCOF: "07", sugICMS: "060", rI: 0.12 },
            { keywords: ["CERVEJA", "CHOPP"], sNCM: "2203.00.00", icmsST: true, pisMono: true, sugPIS: "04", sugCOF: "04", sugICMS: "060", rP: 0.0165, rC: 0.076, rI: 0.18 }
        ];

        window.onload = async () => { try { await signInAnonymously(auth); onAuthStateChanged(auth, u => currentUser = u); } catch (e) { console.error("Erro Auth:", e); } };

        window.handleFileChange = (e) => { 
            filesQueue = Array.from(e.target.files); 
            if(filesQueue.length > 0) { 
                document.getElementById('upload-status').innerText = `${filesQueue.length} XMLs`; 
                document.getElementById('btn-start').disabled = false; 
            } 
        };

        window.runFullSemanticAudit = async () => {
            resetState();
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            const tasks = filesQueue.map(file => new Promise(res => {
                const r = new FileReader();
                r.onload = (e) => { processAuditData(new DOMParser().parseFromString(e.target.result, "text/xml"), file.name); res(); };
                r.readAsText(file);
            }));
            await Promise.all(tasks);
            finalizeAudit();
        };

        function resetState() { state = { xmlCount: 0, itemCount: 0, errorCount: 0, totalRecovery: 0, company: '', cnpj: '', regime: '', competences: new Set(), auditDetails: [] }; document.getElementById('table-body').innerHTML = ""; }

        function processAuditData(xml, fileName) {
            state.xmlCount++;
            const emit = xml.getElementsByTagName("emit")[0];
            if(!state.company) {
                state.company = emit?.getElementsByTagName("xNome")[0]?.textContent || 'N/A';
                state.cnpj = emit?.getElementsByTagName("CNPJ")[0]?.textContent || 'N/A';
                state.regime = "SIMPLES NACIONAL";
            }
            const dets = xml.getElementsByTagName("det");
            Array.from(dets).forEach(item => {
                const prod = item.getElementsByTagName("prod")[0];
                const itemObj = { xProd: prod?.getElementsByTagName("xProd")[0]?.textContent || "", ncm: prod?.getElementsByTagName("NCM")[0]?.textContent || "", vProd: parseFloat(prod?.getElementsByTagName("vProd")[0]?.textContent || 0), oP: "01", oC: "01", oI: "102" };
                performCoreAudit(itemObj, "XML", "01/2026");
            });
        }

        function performCoreAudit(item, origin, period) {
            state.itemCount++;
            let total = 0, status = "CONFORME";
            const matched = INTELLIGENCE_DB.find(r => r.keywords.some(k => item.xProd.toUpperCase().includes(k)));
            if(matched) { status = "DIVERGENTE"; total = item.vProd * 0.04; }
            state.totalRecovery += total;
            state.auditDetails.push({ ...item, status, total, mes: period });
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-4">${item.xProd}</td><td class="p-4">${item.ncm}</td><td class="p-4 text-center">01/01</td><td class="p-4 text-center orange-accent">${matched?matched.sNCM:'-'}</td><td class="p-4 text-center">${status}</td><td class="p-4 text-right text-green-500">R$ ${total.toFixed(2)}</td>`;
            document.getElementById('table-body').appendChild(tr);
        }

        function finalizeAudit() {
            document.getElementById('input-company').value = state.company;
            document.getElementById('kpi-xmls').innerText = state.xmlCount;
            document.getElementById('kpi-items').innerText = state.itemCount;
            document.getElementById('kpi-recovery').innerText = state.totalRecovery.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('btn-save').disabled = false;
            document.getElementById('completion-modal').classList.remove('hidden');
        }

        window.persistAuditData = async () => {
            const fb = document.getElementById('fb-msg'); 
            fb.innerText = "GRAVANDO...";
            if(!currentUser) { fb.innerText = "ERRO: SEM AUTH"; return; }
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'audits'), { 
                    uid: currentUser.uid, 
                    empresa: state.company, 
                    valor: state.totalRecovery, 
                    data: new Date().toISOString() 
                });
                fb.innerText = "SUCESSO!"; fb.style.color = "#10b981";
            } catch (e) { 
                console.error(e);
                fb.innerText = "ERRO AO GRAVAR"; fb.style.color = "#ef4444"; 
            }
        };
    </script>
</body>
</html>

