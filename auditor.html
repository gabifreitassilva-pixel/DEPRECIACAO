<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Fiscal Digital Pro - Auditoria Reversa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        
        .dashboard-card { 
            background-color: #0a0a0a;
            border: 1px solid #222;
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover { border-color: #FF8C00; }
        .orange-accent { color: #FF8C00; }
        .orange-border-top { border-top: 4px solid #FF8C00; }
        .orange-border-left { border-left: 4px solid #FF8C00; }

        .btn-orange {
            background-color: #FF8C00;
            color: #000;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-orange:hover:not(:disabled) {
            background-color: #ff9d26;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
        }

        .btn-orange:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }

        input[readonly] { background-color: #111 !important; color: #ccc !important; border-color: #222 !important; }

        .table-container { max-height: 550px; overflow-y: auto; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF8C00; }

        #completion-modal { background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        
        .badge-tax { font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: bold; margin-right: 2px; line-height: 1.5; display: inline-block; margin-bottom: 2px; }
        .bg-pis { background-color: #3b82f6; color: white; }
        .bg-cof { background-color: #6366f1; color: white; }
        .bg-icms { background-color: #f59e0b; color: white; }
        .bg-ipi { background-color: #ef4444; color: white; }
        .bg-ncm-sug { background-color: #10b981; color: white; }
        .bg-import { background-color: #ffffff; color: #000; }

        .text-sugestao { color: #FF8C00; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-black text-white p-6 border-b border-zinc-800 shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-orange-500 p-2 rounded-lg shadow-[0_0_15px_rgba(255,140,0,0.4)]">
                    <i class="fas fa-file-invoice-dollar text-black text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter uppercase italic">Auditor <span class="orange-accent">Fiscal</span> Total</h1>
                    <p class="text-[10px] opacity-60 uppercase tracking-[0.3em]">IA de NCM e Auditoria Reversa Excel</p>
                </div>
            </div>
            <div class="text-right border-l border-zinc-800 pl-6 hidden md:block">
                <span id="header-company" class="block font-bold text-orange-500 text-lg tracking-tight">Aguardando Dados</span>
                <div class="flex gap-4 justify-end text-[10px] uppercase font-bold text-zinc-500">
                    <span id="header-regime">REGIME: --</span>
                    <span id="header-competence">MÊS: --</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4 flex-1">
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="dashboard-card p-6 rounded-xl orange-border-top shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-id-card orange-accent"></i>Dados Identificados
                </h2>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase">Empresa</label>
                        <input type="text" id="input-company" readonly placeholder="..." class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase">Regime Tributário</label>
                        <input type="text" id="input-regime" readonly placeholder="..." class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase">CNPJ</label>
                        <input type="text" id="input-cnpj" readonly placeholder="..." class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase">Períodos</label>
                        <input type="text" id="input-period" readonly placeholder="..." class="w-full p-2.5 rounded mt-1 border border-zinc-800 text-sm outline-none">
                    </div>
                </div>
            </div>

            <div class="dashboard-card p-6 rounded-xl orange-border-top flex flex-col shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-folder-open orange-accent"></i>Importar Notas (XML)
                </h2>
                <div class="flex-1 border-2 border-dashed border-zinc-800 rounded-lg flex flex-col items-center justify-center p-4 group hover:border-orange-500 transition cursor-pointer" onclick="document.getElementById('xml-input').click()">
                    <input type="file" id="xml-input" multiple accept=".xml" class="hidden" onchange="handleFileChange(event)">
                    <i class="fas fa-cloud-arrow-up text-3xl text-zinc-700 mb-2 group-hover:text-orange-500"></i>
                    <p id="upload-status" class="text-xs text-zinc-500 font-medium text-center uppercase tracking-tighter">Selecione arquivos SAT/NFe</p>
                </div>
                <button id="btn-start" disabled onclick="runFullSemanticAudit()" class="btn-orange mt-4 py-4 rounded-lg flex items-center justify-center gap-2 shadow-lg">
                    <i class="fas fa-bolt"></i> Iniciar Auditoria
                </button>
            </div>

            <div class="dashboard-card p-6 rounded-xl orange-border-top shadow-lg">
                <h2 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-gears orange-accent"></i>Gerenciamento
                </h2>
                <div class="space-y-3">
                    <button id="btn-excel" disabled onclick="exportComparativeExcel()" class="w-full btn-orange py-3 rounded flex items-center justify-center gap-2">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>

                    <button id="btn-import-excel" onclick="document.getElementById('excel-import-input').click()" class="w-full btn-orange py-3 rounded flex items-center justify-center gap-2">
                        <i class="fas fa-file-import"></i> Importar Auditoria Excel
                    </button>
                    <input type="file" id="excel-import-input" accept=".csv" class="hidden" onchange="handleExcelImport(event)">

                    <button id="btn-save" disabled onclick="persistAuditData()" class="w-full btn-orange py-3 rounded flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> Gravar Auditoria
                    </button>
                    <button onclick="window.location.reload()" class="w-full border border-zinc-800 py-3 rounded text-zinc-500 font-bold hover:bg-zinc-900 transition text-xs uppercase">
                        <i class="fas fa-eraser mr-2"></i>Limpar Análise
                    </button>
                    <div id="fb-msg" class="text-center text-[10px] font-bold mt-1 uppercase tracking-widest"></div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="dashboard-card p-5 rounded-xl orange-border-left shadow-lg">
                <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">Lote de Notas</p>
                <h3 id="kpi-xmls" class="text-3xl font-black text-white">0</h3>
            </div>
            <div class="dashboard-card p-5 rounded-xl orange-border-left shadow-lg">
                <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">Itens Auditados</p>
                <h3 id="kpi-items" class="text-3xl font-black text-white">0</h3>
            </div>
            <div class="dashboard-card p-5 rounded-xl border-l-4 border-red-600 shadow-lg">
                <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">Inconsistências</p>
                <h3 id="kpi-errors" class="text-3xl font-black text-red-500">0%</h3>
            </div>
            <div class="dashboard-card p-5 rounded-xl border-l-4 border-green-600 bg-green-950/10 shadow-lg">
                <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest text-green-600">Total Recuperável</p>
                <h3 id="kpi-recovery" class="text-3xl font-black text-green-500">R$ 0,00</h3>
            </div>
        </section>

        <section class="dashboard-card rounded-xl overflow-hidden shadow-2xl">
            <div class="p-5 border-b border-zinc-800 bg-zinc-900/40 flex justify-between items-center">
                <h2 class="font-bold text-zinc-200 uppercase text-xs tracking-widest">Relatório: Original vs Sugestão do Auditor</h2>
                <div id="loader" class="hidden flex items-center gap-2 text-[10px] font-bold text-orange-500 animate-pulse uppercase">
                    <i class="fas fa-sync fa-spin"></i> Inteligência Fiscal Processando...
                </div>
            </div>
            <div class="table-container">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-black text-zinc-500 sticky top-0 z-10 border-b border-zinc-800 uppercase">
                        <tr>
                            <th class="p-4 font-bold">Documento / Produto</th>
                            <th class="p-4 font-bold">NCM Original</th>
                            <th class="p-4 font-bold text-center">Tributos Originais</th>
                            <th class="p-4 font-bold text-center text-orange-500">Sugestão Técnica</th>
                            <th class="p-4 font-bold text-red-500 text-center">Status Auditoria</th>
                            <th class="p-4 font-bold text-green-500 text-right">Crédito Est.</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-zinc-900 text-zinc-300">
                    </tbody>
                </table>
                <div id="empty-state" class="p-20 text-center text-zinc-800 opacity-20 uppercase font-bold tracking-widest text-sm">
                    Importe arquivos XML ou uma Auditoria Excel já realizada.
                </div>
            </div>
        </section>
    </main>

    <div id="completion-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden p-4">
        <div class="bg-zinc-900 border border-orange-500 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_rgba(255,140,0,0.5)]">
                <i class="fas fa-check text-black text-2xl"></i>
            </div>
            <h3 class="text-xl font-black text-white uppercase mb-2">Auditoria Concluída</h3>
            <p id="modal-desc" class="text-zinc-400 text-sm mb-6">A análise profunda foi finalizada com sucesso.</p>
            <button onclick="document.getElementById('completion-modal').classList.add('hidden')" class="btn-orange w-full py-3 rounded-xl">Entendido</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'auditor-sp-pro-v7';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let filesQueue = [];
        let state = {
            xmlCount: 0, itemCount: 0, errorCount: 0, totalRecovery: 0,
            company: '', cnpj: '', regime: '', competences: new Set(),
            auditDetails: []
        };

        const MONTH_NAMES = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        const INTELLIGENCE_DB = [
            { keywords: ["SORVETE", "PICOLÉ", "POTE 2L", "MILHO", "GELADO"], sNCM: "2105.00.10", icmsST: true, pisMono: false, sugPIS: "07", sugCOF: "07", sugICMS: "060", sugIPI: "53", rI: 0.12 },
            { keywords: ["CERVEJA", "CHOPP", "MALZBIER", "SKOL", "BRAHMA"], sNCM: "2203.00.00", icmsST: true, pisMono: true, sugPIS: "04", sugCOF: "04", sugICMS: "060", sugIPI: "52", rP: 0.0165, rC: 0.076, rI: 0.18 },
            { keywords: ["SHAMPOO", "CREME", "COSMETICO", "BATOM", "MAQUIAGEM"], sNCM: "3304.99.10", icmsST: true, pisMono: true, sugPIS: "04", sugCOF: "04", sugICMS: "060", sugIPI: "52", rP: 0.0165, rC: 0.076, rI: 0.18 }
        ];

        window.onload = async () => {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, u => currentUser = u);
            } catch (e) { console.error("Firebase offline"); }
        };

        window.handleFileChange = (event) => {
            filesQueue = Array.from(event.target.files);
            if (filesQueue.length > 0) {
                document.getElementById('upload-status').innerText = `${filesQueue.length} XMLs IDENTIFICADOS`;
                document.getElementById('btn-start').disabled = false;
            }
        };

        window.runFullSemanticAudit = async () => {
            resetState();
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            const tasks = filesQueue.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
                        processAuditData(xml, file.name);
                        resolve();
                    };
                    reader.readAsText(file);
                });
            });
            await Promise.all(tasks);
            finalizeAudit();
        };

        window.handleExcelImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                processExcelData(text);
            };
            reader.readAsText(file);
        };

        function processExcelData(csvText) {
            resetState();
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 2) return;

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cols = lines[i].split(";");
                
                if (!state.company) {
                    state.company = cols[0] || 'N/A';
                    state.cnpj = cols[1]?.replace(/[="]/g, '') || 'N/A';
                    state.regime = cols[2] || 'N/A';
                }
                state.competences.add(cols[3]);
                
                const reItem = {
                    docId: cols[4],
                    xProd: cols[5],
                    ncm: cols[6],
                    oP: cols[7], oC: cols[9], oI: cols[11], oIPI: cols[13],
                    vProd: 100 
                };

                performCoreAudit(reItem, "Importação Excel", cols[3]);
            }
            finalizeAudit("Re-auditoria via Excel finalizada.");
        }

        function resetState() {
            state = { xmlCount: 0, itemCount: 0, errorCount: 0, totalRecovery: 0, company: '', cnpj: '', regime: '', competences: new Set(), auditDetails: [] };
            document.getElementById('table-body').innerHTML = "";
        }

        function processAuditData(xml, fileName) {
            state.xmlCount++;
            const nCFe = xml.getElementsByTagName("nCFe")[0]?.textContent;
            const nNF = xml.getElementsByTagName("nNF")[0]?.textContent;
            const docId = nCFe || nNF || 'S/N';

            const crt = xml.getElementsByTagName("CRT")[0]?.textContent || xml.getElementsByTagName("cRegTrib")[0]?.textContent;
            const emit = xml.getElementsByTagName("emit")[0];
            
            if (!state.company) {
                state.company = emit?.getElementsByTagName("xNome")[0]?.textContent || 'N/A';
                state.cnpj = (emit?.getElementsByTagName("CNPJ")[0]?.textContent || '').replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
                state.regime = crt === "1" ? "SIMPLES NACIONAL" : "REGIME NORMAL";
            }

            const dEmi = xml.getElementsByTagName("dEmi")[0]?.textContent || xml.getElementsByTagName("dhEmi")[0]?.textContent;
            let pStr = "---";
            if (dEmi && dEmi.length >= 7) {
                const mes = dEmi.includes("-") ? dEmi.substring(5, 7) : dEmi.substring(4, 6);
                pStr = `${MONTH_NAMES[parseInt(mes)-1]}/${dEmi.substring(0,4)}`;
                state.competences.add(pStr);
            }

            const dets = xml.getElementsByTagName("det");
            Array.from(dets).forEach(item => {
                const prod = item.getElementsByTagName("prod")[0];
                const icms = item.getElementsByTagName("ICMS")[0];
                
                const itemObj = {
                    docId,
                    xProd: prod?.getElementsByTagName("xProd")[0]?.textContent || "",
                    ncm: prod?.getElementsByTagName("NCM")[0]?.textContent || "",
                    vProd: parseFloat(prod?.getElementsByTagName("vProd")[0]?.textContent || 0),
                    oP: item.getElementsByTagName("PIS")[0]?.getElementsByTagName("CST")[0]?.textContent || "N/A",
                    oC: item.getElementsByTagName("COFINS")[0]?.getElementsByTagName("CST")[0]?.textContent || "N/A",
                    oI: icms?.getElementsByTagName("CST")[0]?.textContent || icms?.getElementsByTagName("CSOSN")[0]?.textContent || "N/A",
                    oIPI: item.getElementsByTagName("IPI")[0]?.getElementsByTagName("CST")[0]?.textContent || "N/A"
                };
                performCoreAudit(itemObj, fileName, pStr);
            });
        }

        function performCoreAudit(item, origin, period) {
            state.itemCount++;
            let status = "CONFORME", critical = false;
            let recP = 0, recC = 0, recI = 0;
            let sNCM_UI = "", sP_UI = "", sC_UI = "", sI_UI = "", sIPI_UI = "";

            const matchedRule = INTELLIGENCE_DB.find(r => r.keywords.some(k => item.xProd.toUpperCase().includes(k)));

            if (!item.ncm || item.ncm === "0" || item.ncm === "00000000") {
                status = "NCM ZERADO"; critical = true;
                if(matchedRule) sNCM_UI = matchedRule.sNCM;
            } else if (matchedRule && item.ncm.replace(/\D/g,'') !== matchedRule.sNCM.replace(/\D/g,'')) {
                status = "NCM DIVERGENTE"; critical = true; sNCM_UI = matchedRule.sNCM;
            }

            if (matchedRule) {
                if (state.regime.includes("SIMPLES")) {
                    if (matchedRule.icmsST && item.oI !== "500") {
                        status = critical ? status : "ICMS ST NÃO SEGREGADO"; critical = true; recI = item.vProd * 0.035; sI_UI = "500";
                    }
                    if (matchedRule.pisMono && (item.oP === "01" || item.oP === "49")) {
                        status = critical ? status : "PIS/COF MONO NÃO SEGREGADO"; critical = true; recP = item.vProd * 0.0035; recC = item.vProd * 0.016; sP_UI = "07"; sC_UI = "07";
                    }
                } else {
                    if (matchedRule.pisMono && item.oP !== matchedRule.sugPIS) {
                        status = critical ? status : "ERRO CST PIS MONO"; critical = true; recP = item.vProd * matchedRule.rP; recC = item.vProd * matchedRule.rC; sP_UI = matchedRule.sugPIS; sC_UI = matchedRule.sugCOF;
                    }
                    if (matchedRule.icmsST && item.oI !== "060") {
                        status = critical ? status : "ERRO CST ICMS ST"; critical = true; recI = item.vProd * matchedRule.rI; sI_UI = "060";
                    }
                }
            }

            if (critical) state.errorCount++;
            const total = recP + recC + recI;
            state.totalRecovery += total;

            state.auditDetails.push({
                empresa: state.company, cnpj: state.cnpj, regime: state.regime, mes: period, nota: item.docId, produto: item.xProd,
                ncm: item.ncm, sNCM: sNCM_UI, oP: item.oP, sP: sP_UI, oC: item.oC, sC: sC_UI, oI: item.oI, sI: sI_UI, oIPI: item.oIPI, status, total
            });

            const tr = document.createElement('tr');
            tr.className = critical ? "bg-red-500/5 hover:bg-red-500/10 transition" : "hover:bg-zinc-900/40 transition";
            tr.innerHTML = `
                <td class="p-4 border-b border-zinc-900/50"><div class="font-bold text-white uppercase text-[10px] truncate w-40">${item.xProd}</div><div class="text-[8px] text-orange-500">Doc: ${item.docId}</div></td>
                <td class="p-4 font-mono"><span class="badge-tax bg-zinc-800">O: ${item.ncm}</span></td>
                <td class="p-4 text-center leading-tight"><span class="badge-tax bg-pis">PIS:${item.oP}</span><span class="badge-tax bg-cof">COF:${item.oC}</span><br><span class="badge-tax bg-icms">ICMS:${item.oI}</span></td>
                <td class="p-4 text-center leading-tight text-sugestao">
                    ${sNCM_UI ? `<span class="badge-tax bg-ncm-sug">NCM:${sNCM_UI}</span><br>` : ''}
                    ${sP_UI ? `<span class="badge-tax bg-pis">PIS:${sP_UI}</span>` : ''}${sC_UI ? `<span class="badge-tax bg-cof">COF:${sC_UI}</span>` : ''}<br>
                    ${sI_UI ? `<span class="badge-tax bg-icms">ICMS:${sI_UI}</span>` : ''}
                </td>
                <td class="p-4 font-black ${critical ? 'text-red-500' : 'text-zinc-800'} uppercase text-[9px] text-center">${status}<br><span class="text-zinc-600">${period}</span></td>
                <td class="p-4 text-right"><div class="text-green-500 font-black">${total > 0 ? 'R$ ' + total.toFixed(2) : '-'}</div></td>
            `;
            document.getElementById('table-body').appendChild(tr);
        }

        function finalizeAudit(msg = "Auditoria completa!") {
            document.getElementById('input-company').value = state.company;
            document.getElementById('input-regime').value = state.regime;
            document.getElementById('input-cnpj').value = state.cnpj;
            const ps = Array.from(state.competences).sort();
            document.getElementById('input-period').value = ps.join(", ");
            document.getElementById('header-company').innerText = state.company;
            document.getElementById('header-regime').innerText = `REGIME: ${state.regime}`;
            document.getElementById('header-competence').innerText = `MÊS: ${ps[0] || '--'}`;
            document.getElementById('kpi-xmls').innerText = state.xmlCount || "--";
            document.getElementById('kpi-items').innerText = state.itemCount;
            document.getElementById('kpi-errors').innerText = state.itemCount > 0 ? `${((state.errorCount/state.itemCount)*100).toFixed(1)}%` : "0%";
            document.getElementById('kpi-recovery').innerText = state.totalRecovery.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('btn-excel').disabled = false;
            document.getElementById('btn-save').disabled = false;
            document.getElementById('modal-desc').innerText = msg;
            document.getElementById('completion-modal').classList.remove('hidden');
        }

        window.exportComparativeExcel = () => {
            if (state.auditDetails.length === 0) return;
            let csv = "Empresa;CNPJ;Regime;Mes;Nota;Produto;NCM Original;PIS Original;PIS Sugerido;COF Original;COF Sugerido;ICMS Original;ICMS Sugerido;IPI Original;Status;Credito\n";
            state.auditDetails.forEach(d => {
                const row = [d.empresa, `="${d.cnpj}"`, d.regime, d.mes, d.nota, d.produto.replace(/;/g, "-"), d.ncm, d.oP, d.sP || "", d.oC, d.sC || "", d.oI, d.sI || "", d.oIPI, d.status, d.total.toFixed(2).replace(".", ",")].join(";");
                csv += row + "\n";
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Auditoria_Completa_${state.company.replace(/\s+/g, "_")}.csv`;
            a.click();
        };

        window.persistAuditData = async () => {
            const fb = document.getElementById('fb-msg'); fb.innerText = "GRAVANDO...";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'audits'), { uid: currentUser.uid, empresa: state.company, valor: state.totalRecovery, data: new Date().toISOString() });
                fb.innerText = "SUCESSO!"; fb.style.color = "#10b981";
            } catch (e) { fb.innerText = "ERRO!"; fb.style.color = "#ef4444"; }
        };
    </script>
</body>
</html>
