<div class="card-auditoria-central">
    <h3>üöÄ Auditoria de Recupera√ß√£o Simples Nacional</h3>
    <p>Importe os arquivos XML para cruzar com todos os anexos setoriais.</p>
    <input type="file" id="inputXml" multiple accept=".xml" onchange="executarAuditoriaCompleta(this.files)">
</div>

<div id="painel-auditoria-resultados" style="display:none; margin-top:20px;"></div>

<script>
// 1. MAPEAMENTO GLOBAL DE TODOS OS SEUS ANEXOS 
const DB_FISCAL_TOTAL = {
    "Auto Pe√ßas": ["8708", "4011", "8433", "8421", "8511", "8512"], // 
    "Bebidas": ["2202", "2203"], // 
    "Perfumaria": ["3303", "3304", "3305", "3307", "3401"], // 
    "Produtos Aliment√≠cios": ["1902", "1905", "2106"], // 
    "Materiais de Constru√ß√£o": ["7308", "3214", "3824", "3917"], // 
    "Eletrodom√©sticos/Eletr√¥nicos": ["8418", "8450", "8516", "8528"], // 
    "Papelaria": ["4820", "4901", "9608", "9609"], // 
    "Brinquedos/Esporte": ["9503", "9504", "9506"], // 
    "Combust√≠veis": ["2710", "2711"], // 
    "Limpeza": ["3402", "3808", "4818"] // 
};

// 2. MOTOR DE PROCESSAMENTO
async function executarAuditoriaCompleta(files) {
    const painel = document.getElementById('painel-auditoria-resultados');
    painel.style.display = 'block';
    painel.innerHTML = "<h4>Analisando dados fiscais...</h4>";

    let vTotalRecuperar = 0;
    let listaAlertas = "";

    for (let arquivo of files) {
        const conteudo = await arquivo.text();
        const xml = new DOMParser().parseFromString(conteudo, "text/xml");
        const itens = xml.getElementsByTagName("det");

        for (let i = 0; i < itens.length; i++) {
            const ncm = itens[i].getElementsByTagName("NCM")[0].textContent;
            const descricao = itens[i].getElementsByTagName("xProd")[0].textContent;
            const valor = parseFloat(itens[i].getElementsByTagName("vProd")[0].textContent);
            
            // Busca em TODOS os seus anexos
            let setorIdentificado = null;
            for (let setor in DB_FISCAL_TOTAL) {
                if (DB_FISCAL_TOTAL[setor].some(prefixo => ncm.startsWith(prefixo))) {
                    setorIdentificado = setor;
                    break;
                }
            }

            if (setorIdentificado) {
                // C√°lculo de PIS/COFINS Monof√°sico (Exclus√£o da Base do Simples)
                const recuperacao = valor * 0.0198; 
                vTotalRecuperar += recuperacao;

                listaAlertas += `
                    <div class="alerta-divergencia" style="border-left: 4px solid #e67e22; padding: 10px; margin-bottom: 5px; background: #fffcf5;">
                        <span style="color:#d35400;">üö© <b>FORA DA LEI:</b></span> ${descricao}<br>
                        <b>NCM:</b> ${ncm} | <b>Setor:</b> ${setorIdentificado}<br>
                        <small>Base Legal: Lei 10.147/00 aplicada conforme seu arquivo <i>baselegal.html</i></small>
                    </div>`;
            }
        }
    }

    // Exibi√ß√£o Final
    painel.innerHTML = `
        <div style="background:#27ae60; color:white; padding:15px; border-radius:5px; margin-bottom:15px;">
            <h3>Recupera√ß√£o Total Estimada: R$ ${vTotalRecuperar.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h3>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            ${listaAlertas || "<p>Nenhuma irregularidade encontrada nos XMLs.</p>"}
        </div>
    `;
}

// 3. REGISTRO DO SERVICE WORKER (Para Atualiza√ß√µes)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(reg => {
        reg.onupdatefound = () => {
            const installingWorker = reg.installing;
            installingWorker.onstatechange = () => {
                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    alert("Nova vers√£o das leis fiscais dispon√≠vel! Reiniciando...");
                    window.location.reload();
                }
            };
        };
    });
}
</script>
