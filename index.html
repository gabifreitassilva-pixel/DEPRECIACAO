<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <title>FISCO CAPITAL - PWA</title>
    
    <!-- Link para o Manifesto (Transforma em App) -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            black: '#0f0f0f', dark: '#1a1a1a', gray: '#2a2a2a',
                            orange: '#f97316', orangeHover: '#ea580c', text: '#f3f4f6',
                            muted: '#9ca3af', success: '#10b981', danger: '#ef4444', info: '#3b82f6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"]::file-selector-button {
            background-color: #2a2a2a; color: #f97316; border: 1px solid #f97316;
            padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; margin-right: 10px;
        }
        input[type="file"]::file-selector-button:hover { background-color: #f97316; color: white; }
        .tab-active { border-bottom: 2px solid #f97316; color: #f97316; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            body { background: white !important; color: black !important; }
            header, .tabs-nav, #view-guia, #view-historico, .no-print { display: none !important; }
            #view-calculadora { display: block !important; }
            .bg-brand-dark, .bg-brand-black { background: white !important; border: 1px solid #ddd !important; }
            input, select { border: 1px solid #ccc !important; }
            #areaExplicacao { border: 1px solid #000 !important; color: black !important; }
            * { text-shadow: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-brand-black text-brand-text min-h-screen pb-10">

    <!-- Header -->
    <header class="bg-brand-dark border-b border-brand-gray sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-brand-orange/10 p-2 rounded border border-brand-orange/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-orange" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tighter leading-none text-white">FISCO <span class="text-brand-orange">CAPITAL</span></h1>
                    <span class="text-[10px] text-brand-muted uppercase tracking-widest">Sistema Local (PWA)</span>
                </div>
            </div>
            <div id="pwaStatus" class="text-[10px] text-green-500 hidden">App Instalado</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Tabs -->
        <div class="tabs-nav flex gap-6 mb-8 border-b border-brand-gray text-sm font-medium overflow-x-auto">
            <button onclick="switchTab('calculadora')" id="tab-calculadora" class="pb-3 tab-active hover:text-brand-orange transition-colors flex items-center gap-2">Simulador & Cálculo</button>
            <button onclick="switchTab('guia')" id="tab-guia" class="pb-3 text-brand-muted hover:text-brand-orange transition-colors flex items-center gap-2">Guia Fiscal</button>
            <button onclick="switchTab('historico')" id="tab-historico" class="pb-3 text-brand-muted hover:text-brand-orange transition-colors flex items-center gap-2">Histórico & Backup</button>
        </div>

        <!-- VISÃO 1: CALCULADORA -->
        <div id="view-calculadora" class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray shadow-lg relative">
                    <div id="editModeIndicator" class="hidden absolute top-0 right-0 bg-brand-orange text-white text-xs px-3 py-1 rounded-bl-lg font-bold shadow-lg">EDITANDO</div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-brand-orange flex items-center gap-2">Dados da Operação</h2>
                        <button onclick="window.print()" class="no-print text-xs border border-brand-gray text-brand-muted hover:text-white px-3 py-1 rounded transition-colors">Imprimir</button>
                    </div>
                    
                    <form id="calcForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="editId">

                        <div class="md:col-span-1">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Empresa</label>
                            <input type="text" id="nomeEmpresa" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white focus:border-brand-orange focus:outline-none">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Regime</label>
                            <select id="regimeTributario" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white focus:border-brand-orange focus:outline-none">
                                <option value="simples">Simples Nacional</option>
                                <option value="presumido">Lucro Presumido</option>
                                <option value="real">Lucro Real</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Descrição do Bem</label>
                            <input type="text" id="descricao" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white focus:border-brand-orange focus:outline-none">
                        </div>

                        <div class="p-3 border border-brand-gray rounded bg-brand-black/30 md:col-span-1">
                            <h4 class="text-brand-orange text-xs font-bold mb-2 uppercase">Entrada (Compra)</h4>
                            <div class="space-y-2">
                                <div><label class="text-[10px] text-brand-muted">Data</label><input type="date" id="dataAquisicao" class="w-full bg-brand-black border border-brand-gray rounded p-1.5 text-white [color-scheme:dark]"></div>
                                <div><label class="text-[10px] text-brand-muted">Valor Total (R$)</label><input type="text" id="valorAquisicao" oninput="mascaraMoeda(this)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono"></div>
                            </div>
                        </div>

                        <div class="p-3 border border-brand-gray rounded bg-brand-black/30 md:col-span-1">
                            <h4 class="text-brand-orange text-xs font-bold mb-2 uppercase">Saída (Venda)</h4>
                            <div class="space-y-2">
                                <div><label class="text-[10px] text-brand-muted">Data</label><input type="date" id="dataVenda" class="w-full bg-brand-black border border-brand-gray rounded p-1.5 text-white [color-scheme:dark]"></div>
                                <div><label class="text-[10px] text-brand-muted">Valor Venda (R$)</label><input type="text" id="valorVenda" oninput="mascaraMoeda(this)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono"></div>
                            </div>
                        </div>

                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 bg-brand-black/20 p-3 rounded border border-brand-gray">
                            <div>
                                <label class="block text-xs text-brand-muted mb-1">Depreciação Anual</label>
                                <select id="tipoDepreciacao" onchange="toggleDepreciacaoCustom(this.value)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-sm mb-2">
                                    <option value="20">Veículos (20%)</option>
                                    <option value="20">Informática (20%)</option>
                                    <option value="10">Móveis (10%)</option>
                                    <option value="custom">Outra (Personalizar)</option>
                                </select>
                                <input type="number" id="taxaDepreciacaoCustom" placeholder="%" class="hidden w-20 bg-brand-black border border-brand-gray rounded p-2 text-white text-right">
                            </div>
                            <div>
                                <label class="block text-xs text-brand-muted mb-1">Despesas Venda (R$)</label>
                                <input type="text" id="despesasVenda" oninput="mascaraMoeda(this)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono">
                            </div>
                        </div>

                        <div class="md:col-span-2 border-t border-brand-gray pt-4 no-print">
                            <h3 class="text-sm font-semibold text-white mb-3">Anexar Documentos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="bg-brand-black/40 p-2 rounded border border-brand-gray border-dashed">
                                    <label class="block text-[10px] text-brand-muted uppercase mb-1">1. NF Compra</label>
                                    <input type="file" id="nfCompra" accept=".pdf,.jpg,.png" class="text-[10px] text-brand-muted w-full">
                                    <p id="labelCompra" class="text-[9px] text-brand-success mt-1 hidden"></p>
                                </div>
                                <div class="bg-brand-black/40 p-2 rounded border border-brand-gray border-dashed">
                                    <label class="block text-[10px] text-brand-muted uppercase mb-1">2. NF Venda</label>
                                    <input type="file" id="nfVenda" accept=".pdf,.jpg,.png" class="text-[10px] text-brand-muted w-full">
                                    <p id="labelVenda" class="text-[9px] text-brand-success mt-1 hidden"></p>
                                </div>
                                <div class="bg-brand-black/40 p-2 rounded border border-brand-gray border-dashed relative">
                                    <label class="block text-[10px] text-brand-muted uppercase mb-1">3. Declaração</label>
                                    <input type="file" id="fileDeclaracao" accept=".pdf,.jpg,.png" class="text-[10px] text-brand-muted w-full">
                                    <p id="labelDeclaracao" class="text-[9px] text-brand-success mt-1 hidden"></p>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <div class="mt-6 flex justify-end gap-3 no-print">
                        <button onclick="limparFormulario()" class="px-4 py-2 text-sm text-brand-muted hover:text-white">Cancelar</button>
                        <button onclick="calcularSimulacao()" id="btnAcao" class="bg-brand-orange hover:bg-brand-orangeHover text-white px-6 py-2 rounded font-bold shadow-lg transition-all">Calcular</button>
                    </div>
                </div>

                <div id="areaExplicacao" class="hidden animate-fade-in mt-6 bg-brand-info/10 border border-brand-info/30 rounded-lg p-5">
                    <h3 class="text-lg font-bold text-brand-info mb-3 flex items-center gap-2">Entenda o Cálculo</h3>
                    <div class="text-sm space-y-3 text-gray-300 leading-relaxed">
                        <p id="txtExp1"></p>
                        <div class="bg-brand-black/50 p-3 rounded border-l-4 border-brand-info">
                            <p class="font-bold text-white mb-1">Análise Fiscal:</p>
                            <p id="txtExp2"></p>
                        </div>
                        <p id="txtExp3" class="text-xs text-brand-muted italic mt-2"></p>
                    </div>
                </div>
            </div>

            <!-- Resultados -->
            <div class="lg:col-span-1">
                <div id="cardResultado" class="bg-brand-dark p-0 rounded-lg border border-brand-gray h-full opacity-50 pointer-events-none transition-all duration-300 flex flex-col sticky top-24">
                    <div class="bg-brand-black p-4 border-b border-brand-gray">
                        <h2 class="text-lg font-bold text-white">Apuração Fiscal</h2>
                    </div>
                    <div class="p-5 space-y-5 flex-grow">
                        <div>
                            <p class="text-[10px] uppercase text-brand-muted mb-2 font-bold tracking-wider">Dados Contábeis</p>
                            <div class="bg-brand-black/50 rounded border border-brand-gray p-3 space-y-2">
                                <div class="flex justify-between text-xs"><span class="text-brand-muted">Tempo de Uso:</span><span id="resTempo" class="text-white">-</span></div>
                                <div class="flex justify-between text-xs"><span class="text-brand-muted">Depreciação (-):</span><span id="resDepreciacao" class="text-brand-danger">-</span></div>
                                <div class="border-t border-gray-700 my-1"></div>
                                <div class="flex justify-between text-sm font-bold"><span class="text-white">Valor Contábil:</span><span id="resValorContabil" class="text-white">-</span></div>
                            </div>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-brand-muted mb-2 font-bold tracking-wider">Apuração do Ganho</p>
                            <div class="bg-brand-black rounded border border-brand-gray p-4 text-center">
                                <span class="text-xs text-brand-muted block mb-1">Ganho de Capital</span>
                                <span id="resGanho" class="text-2xl font-black text-white block">-</span>
                            </div>
                        </div>
                        <div class="relative">
                            <div class="absolute -left-5 top-3 w-1 h-8 bg-brand-orange"></div>
                            <div class="pl-0">
                                <p class="text-[10px] uppercase text-brand-muted mb-1">Imposto Estimado</p>
                                <p id="resImposto" class="text-xl font-bold text-brand-orange">-</p>
                                <p id="resDarfInfo" class="text-[10px] text-gray-400 mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISÃO 2: GUIA -->
        <div id="view-guia" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="bg-brand-info/10 border border-brand-info/30 p-6 rounded-lg">
                        <h3 class="text-brand-info font-bold text-lg mb-2">Tem Inscrição Estadual (IE)?</h3>
                        <p class="text-sm text-gray-200 mb-3">Se sim, você é <strong>OBRIGADO</strong> a emitir NF-e Modelo 55.</p>
                        <p class="text-xs text-brand-muted">A declaração é apenas para isentos de IE.</p>
                    </div>
                    <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray">
                        <h3 class="text-brand-orange font-bold text-lg mb-3">Dados para NF-e</h3>
                        <ul class="text-sm text-gray-300 space-y-3">
                            <li><strong>CFOP:</strong> 5.551 (Estadual) / 6.551 (Interestadual)</li>
                            <li><strong>CST ICMS:</strong> 041</li>
                            <li><strong>CST PIS/COFINS:</strong> 08</li>
                        </ul>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray">
                        <h3 class="text-brand-orange font-bold text-lg mb-3">Declaração (Sem IE)</h3>
                        <button onclick="abrirModeloDeclaracao()" class="w-full bg-brand-gray hover:bg-brand-orange text-white py-3 rounded font-bold transition-colors">Gerar Modelo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISÃO 3: HISTÓRICO -->
        <div id="view-historico" class="hidden animate-fade-in">
            <div class="bg-brand-dark rounded-lg border border-brand-gray overflow-hidden">
                <div class="p-4 border-b border-brand-gray flex justify-between items-center bg-brand-black/50">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Vendas (Gravadas no Navegador)</h2>
                        <p class="text-xs text-brand-muted">Os dados ficam salvos neste computador</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportarDados()" class="text-xs bg-brand-info/20 text-brand-info border border-brand-info px-3 py-1 rounded hover:bg-brand-info hover:text-white transition-colors">↓ Baixar Backup</button>
                        <button onclick="document.getElementById('fileInputImport').click()" class="text-xs bg-brand-success/20 text-brand-success border border-brand-success px-3 py-1 rounded hover:bg-brand-success hover:text-white transition-colors">↑ Restaurar Backup</button>
                        <input type="file" id="fileInputImport" class="hidden" accept=".json" onchange="importarDados(this)">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-brand-black text-brand-muted uppercase text-[10px] tracking-wider">
                            <tr>
                                <th class="px-4 py-3 border-b border-brand-gray">Empresa</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-right">Compra</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-right">Venda</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-right text-brand-orange">Lucro</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-right text-red-400">Imposto</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-center">Docs</th>
                                <th class="px-4 py-3 border-b border-brand-gray text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaHistorico" class="divide-y divide-brand-gray/30"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modais -->
    <div id="modalDeclaracao" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] p-4 no-print">
        <div class="bg-white text-black p-8 rounded-lg max-w-2xl w-full shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Declaração de Não Incidência</h2>
            <div class="font-serif text-sm space-y-4 leading-relaxed bg-gray-50 p-6 border border-gray-300">
                <p class="text-center font-bold">DECLARAÇÃO</p>
                <p>A empresa <strong>[NOME]</strong> declara a venda do ativo imobilizado abaixo com não incidência de ICMS.</p>
                <p class="mt-8 text-center">___________________<br>Assinatura</p>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="document.getElementById('modalDeclaracao').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded">Fechar</button>
                <button onclick="window.print()" class="bg-black text-white px-4 py-2 rounded">Imprimir</button>
            </div>
        </div>
    </div>
    
    <div id="modalArquivo" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] no-print">
        <div class="bg-brand-dark p-6 rounded-lg max-w-md w-full border border-brand-gray">
            <h3 class="text-lg font-bold text-white mb-2">Arquivo</h3>
            <p id="modalFileName" class="text-brand-orange mb-4 text-center border p-2 border-dashed border-brand-gray rounded font-mono break-all"></p>
            <button onclick="document.getElementById('modalArquivo').classList.add('hidden')" class="bg-brand-gray w-full py-2 rounded text-white">Fechar</button>
        </div>
    </div>

    <!-- Script PWA e Lógica -->
    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado!', reg))
                    .catch(err => console.log('Falha ao registrar SW:', err));
            });
        }

        // Lógica da Aplicação
        let currentSimulation = null;
        let historico = JSON.parse(localStorage.getItem('fiscoCapitalDB_v11')) || [];

        // Utils
        const valorParaReal = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const parseCurrency = (str) => !str ? 0 : parseFloat(str.replace(/[^\d,]/g, '').replace(',', '.'));
        const mascaraMoeda = (e) => {
            let input = e.target || e;
            let val = input.value.replace(/\D/g, "");
            if(val === "") { input.value = ""; return; }
            input.value = (parseFloat(val)/100).toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
        };

        function switchTab(tab) {
            ['calculadora', 'guia', 'historico'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tabs-nav button').forEach(b => b.className = "pb-3 text-brand-muted hover:text-brand-orange transition-colors flex items-center gap-2");
            document.getElementById(`tab-${tab}`).className = "pb-3 tab-active hover:text-brand-orange transition-colors flex items-center gap-2";
            if(tab === 'historico') renderHistorico();
        }

        function toggleDepreciacaoCustom(val) {
            const el = document.getElementById('taxaDepreciacaoCustom');
            if(val === 'custom') { el.classList.remove('hidden'); el.focus(); } else { el.classList.add('hidden'); }
        }

        function abrirModeloDeclaracao() {
            document.getElementById('modalDeclaracao').classList.remove('hidden');
            document.getElementById('modalDeclaracao').classList.add('flex');
        }

        function exportarDados() {
            const dataStr = JSON.stringify(historico);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'fisco_backup.json');
            linkElement.click();
        }

        function importarDados(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    historico = JSON.parse(e.target.result);
                    localStorage.setItem('fiscoCapitalDB_v11', JSON.stringify(historico));
                    alert('Dados restaurados!');
                    renderHistorico();
                } catch (err) { alert('Erro no arquivo.'); }
            };
            reader.readAsText(file);
        }

        function calcularSimulacao() {
            const editId = document.getElementById('editId').value;
            const empresa = document.getElementById('nomeEmpresa').value;
            const valorAq = parseCurrency(document.getElementById('valorAquisicao').value);
            const valorVenda = parseCurrency(document.getElementById('valorVenda').value);
            const despesas = parseCurrency(document.getElementById('despesasVenda').value);
            const dataAqVal = document.getElementById('dataAquisicao').value;
            const dataVendaVal = document.getElementById('dataVenda').value;
            const dataAq = new Date(dataAqVal);
            const dataVenda = new Date(dataVendaVal);
            
            let taxa = document.getElementById('tipoDepreciacao').value;
            if(taxa === 'custom') taxa = parseFloat(document.getElementById('taxaDepreciacaoCustom').value);
            else taxa = parseFloat(taxa);

            if(!empresa || !valorAq || !valorVenda || isNaN(dataAq) || isNaN(dataVenda)) {
                alert("Preencha todos os campos."); return;
            }

            const diffTime = Math.abs(dataVenda - dataAq);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const anosFracionados = totalDays / 365.25;
            let depreciacao = valorAq * (taxa/100) * anosFracionados;
            if(depreciacao > valorAq) depreciacao = valorAq;
            const valorContabil = valorAq - depreciacao;
            const ganhoCapital = (valorVenda - despesas) - valorContabil;

            // Arquivos
            const getFile = (id) => document.getElementById(id).files[0]?.name;
            let files = { compra: getFile('nfCompra'), venda: getFile('nfVenda'), decl: getFile('fileDeclaracao') };
            
            if(editId) {
                const old = historico.find(i => i.id == editId);
                if(old) {
                    if(!files.compra) files.compra = old.files?.compra || old.fileCompra;
                    if(!files.venda) files.venda = old.files?.venda || old.fileVenda;
                    if(!files.decl) files.decl = old.files?.decl;
                }
            }

            document.getElementById('areaExplicacao').classList.remove('hidden');
            document.getElementById('txtExp1').innerHTML = `1. Compra: <strong>${valorParaReal(valorAq)}</strong>. <br>2. Depreciação: <strong class="text-red-300">-${valorParaReal(depreciacao)}</strong>.<br>3. Contábil: <strong class="text-white">${valorParaReal(valorContabil)}</strong>.`;
            
            if(ganhoCapital > 0) {
                document.getElementById('txtExp2').innerHTML = `Venda: <strong class="text-green-300">${valorParaReal(valorVenda)}</strong>. Lucro de <strong>${valorParaReal(ganhoCapital)}</strong>.`;
                document.getElementById('txtExp3').innerText = `Imposto incide sobre o lucro.`;
            } else {
                document.getElementById('txtExp2').innerHTML = `Venda sem ganho de capital.`;
                document.getElementById('txtExp3').innerText = "Imposto Zero.";
            }

            currentSimulation = {
                id: editId ? parseInt(editId) : Date.now(),
                empresa, descricao: document.getElementById('descricao').value,
                regime: document.getElementById('regimeTributario').value,
                dataAq: dataAqVal, dataVenda: dataVendaVal,
                valorAq, valorVenda, despesas, taxa,
                depreciacao, valorContabil, ganhoCapital,
                files: files
            };

            document.getElementById('resTempo').innerText = `${anosFracionados.toFixed(1)} anos`;
            document.getElementById('resDepreciacao').innerText = valorParaReal(depreciacao);
            document.getElementById('resValorContabil').innerText = valorParaReal(valorContabil);
            const elGanho = document.getElementById('resGanho');
            elGanho.innerText = valorParaReal(ganhoCapital);
            elGanho.className = ganhoCapital > 0 ? "text-2xl font-black text-brand-success block" : "text-2xl font-black text-brand-muted block";

            let imposto = 0;
            if(ganhoCapital > 0) {
                const regime = document.getElementById('regimeTributario').value;
                imposto = regime === 'simples' ? ganhoCapital * 0.15 : ganhoCapital * 0.24;
                document.getElementById('resDarfInfo').innerText = regime === 'simples' ? "DARF 0507" : "Soma IRPJ/CSLL";
            } else {
                document.getElementById('resDarfInfo').innerText = "Isento";
            }
            document.getElementById('resImposto').innerText = valorParaReal(imposto);
            document.getElementById('cardResultado').classList.remove('opacity-50', 'pointer-events-none');
            
            salvarHistorico();
        }

        function salvarHistorico() {
            const idx = historico.findIndex(i => i.id === currentSimulation.id);
            if(idx !== -1) historico[idx] = currentSimulation;
            else historico.push(currentSimulation);
            
            localStorage.setItem('fiscoCapitalDB_v11', JSON.stringify(historico));
            if(document.getElementById('editId').value) {
                alert("Alterações salvas!");
                limparFormulario();
                switchTab('historico');
            }
        }

        function renderHistorico() {
            const tb = document.getElementById('tabelaHistorico');
            tb.innerHTML = '';
            historico.forEach(item => {
                const f = item.files || {};
                const badges = [
                    f.compra ? `<span onclick="verArquivo('${f.compra}')" class="cursor-pointer text-[10px] text-green-400 border border-green-800 px-1 rounded mx-0.5">CP</span>` : '',
                    f.venda ? `<span onclick="verArquivo('${f.venda}')" class="cursor-pointer text-[10px] text-green-400 border border-green-800 px-1 rounded mx-0.5">VD</span>` : '',
                    f.decl ? `<span onclick="verArquivo('${f.decl}')" class="cursor-pointer text-[10px] text-blue-400 border border-blue-800 px-1 rounded mx-0.5">DC</span>` : ''
                ].join('');
                
                let impostoEst = 0;
                if(item.ganhoCapital > 0) {
                    impostoEst = item.regime === 'simples' ? item.ganhoCapital * 0.15 : item.ganhoCapital * 0.24;
                }

                tb.innerHTML += `
                    <tr class="hover:bg-brand-dark border-b border-brand-gray/50">
                        <td class="px-4 py-3 font-bold text-white">${item.empresa}</td>
                        <td class="px-4 py-3 text-right text-brand-muted text-xs">${valorParaReal(item.valorAq)}</td>
                        <td class="px-4 py-3 text-right text-brand-muted text-xs">${valorParaReal(item.valorVenda)}</td>
                        <td class="px-4 py-3 text-right ${item.ganhoCapital > 0 ? 'text-brand-success' : 'text-brand-muted'} text-xs font-bold">${valorParaReal(item.ganhoCapital)}</td>
                        <td class="px-4 py-3 text-right text-brand-danger text-xs font-bold">${valorParaReal(impostoEst)}</td>
                        <td class="px-4 py-3 text-center whitespace-nowrap">${badges || '-'}</td>
                        <td class="px-4 py-3 text-center flex justify-center gap-2">
                            <button onclick="carregarEdicao(${item.id})" class="text-brand-orange hover:text-white">✎</button>
                            <button onclick="excluirItem(${item.id})" class="text-brand-danger hover:text-white">✕</button>
                        </td>
                    </tr>
                `;
            });
        }

        function carregarEdicao(id) {
            const item = historico.find(i => i.id === id);
            if(!item) return;
            document.getElementById('editId').value = item.id;
            document.getElementById('nomeEmpresa').value = item.empresa;
            document.getElementById('descricao').value = item.descricao;
            document.getElementById('dataAquisicao').value = item.dataAq;
            document.getElementById('dataVenda').value = item.dataVenda;
            document.getElementById('regimeTributario').value = item.regime;
            
            const setVal = (id, val) => { const el = document.getElementById(id); el.value = (val*100).toFixed(0); mascaraMoeda(el); };
            setVal('valorAquisicao', item.valorAq);
            setVal('valorVenda', item.valorVenda);
            setVal('despesasVenda', item.despesas);

            const sel = document.getElementById('tipoDepreciacao');
            const opts = Array.from(sel.options).map(o=>o.value);
            if(opts.includes(String(item.taxa))) { sel.value = item.taxa; toggleDepreciacaoCustom(item.taxa); }
            else { sel.value = 'custom'; toggleDepreciacaoCustom('custom'); document.getElementById('taxaDepreciacaoCustom').value = item.taxa; }

            const f = item.files || {};
            if(f.compra) { document.getElementById('labelCompra').innerText = f.compra; document.getElementById('labelCompra').classList.remove('hidden'); }
            if(f.venda) { document.getElementById('labelVenda').innerText = f.venda; document.getElementById('labelVenda').classList.remove('hidden'); }
            if(f.decl) { document.getElementById('labelDeclaracao').innerText = f.decl; document.getElementById('labelDeclaracao').classList.remove('hidden'); }

            document.getElementById('editModeIndicator').classList.remove('hidden');
            document.getElementById('btnAcao').innerText = "Salvar Alterações";
            document.getElementById('btnAcao').classList.replace('bg-brand-orange', 'bg-brand-success');
            switchTab('calculadora');
        }

        function excluirItem(id) {
            if(confirm("Excluir?")) {
                historico = historico.filter(i => i.id !== id);
                localStorage.setItem('fiscoCapitalDB_v11', JSON.stringify(historico));
                renderHistorico();
            }
        }
        function verArquivo(n) { document.getElementById('modalFileName').innerText = n; document.getElementById('modalArquivo').classList.remove('hidden'); document.getElementById('modalArquivo').classList.add('flex'); }
        function limparFormulario() {
            document.getElementById('calcForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('editModeIndicator').classList.add('hidden');
            document.getElementById('areaExplicacao').classList.add('hidden');
            document.getElementById('cardResultado').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('btnAcao').innerText = "Calcular";
            document.getElementById('btnAcao').classList.replace('bg-brand-success', 'bg-brand-orange');
            ['labelCompra','labelVenda','labelDeclaracao'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            ['resTempo','resDepreciacao','resValorContabil','resGanho','resImposto'].forEach(id=>document.getElementById(id).innerText = '-');
        }
    </script>
</body>
</html>
