<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <title>FISCO CAPITAL - Gest√£o de Ativos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            black: '#0f0f0f', dark: '#1a1a1a', gray: '#2a2a2a',
                            orange: '#f97316', orangeHover: '#ea580c', text: '#f3f4f6',
                            muted: '#9ca3af', success: '#10b981', danger: '#ef4444', info: '#3b82f6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"]::file-selector-button {
            background-color: #2a2a2a; color: #f97316; border: 1px solid #f97316;
            padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; margin-right: 10px;
        }
        .tab-active { border-bottom: 2px solid #f97316; color: #f97316; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body class="bg-brand-black text-brand-text min-h-screen pb-10">

    <header class="bg-brand-dark border-b border-brand-gray sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-brand-orange/10 p-2 rounded border border-brand-orange/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-orange" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                </div>
                <h1 class="text-2xl font-bold tracking-tighter text-white">FISCO <span class="text-brand-orange">CAPITAL</span></h1>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="tabs-nav flex gap-6 mb-8 border-b border-brand-gray text-sm font-medium overflow-x-auto no-print">
            <button onclick="switchTab('calculadora')" id="tab-calculadora" class="pb-3 tab-active">Simulador & C√°lculo</button>
            <button onclick="switchTab('guia')" id="tab-guia" class="pb-3 text-brand-muted">Guia Fiscal & Obriga√ß√µes</button>
            <button onclick="switchTab('historico')" id="tab-historico" class="pb-3 text-brand-muted">Hist√≥rico & Backup</button>
        </div>

        <div id="view-calculadora" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray shadow-lg relative">
                    <div id="editModeIndicator" class="hidden absolute top-0 right-0 bg-brand-orange text-white text-xs px-3 py-1 rounded-bl-lg font-bold">EDITANDO REGISTRO</div>
                    
                    <form id="calcForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="editId">
                        <div class="md:col-span-1">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Nome da Empresa</label>
                            <input type="text" id="nomeEmpresa" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Regime Tribut√°rio</label>
                            <select id="regimeTributario" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white font-bold">
                                <option value="simples">Simples Nacional (15% sobre ganho)</option>
                                <option value="presumido">Lucro Presumido (IRPJ/CSLL)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs uppercase text-brand-muted mb-1">Descri√ß√£o do Bem</label>
                            <input type="text" id="descricao" placeholder="Ex: Ve√≠culo Ford Ka 2020" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white">
                        </div>
                        
                        <div class="p-4 bg-brand-black/30 border border-brand-gray rounded">
                            <h4 class="text-brand-orange text-xs font-bold mb-3 uppercase font-mono">Aquisi√ß√£o (Entrada)</h4>
                            <label class="text-[10px] text-brand-muted uppercase">Data de Compra</label>
                            <input type="date" id="dataAquisicao" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white mb-2 [color-scheme:dark]">
                            <label class="text-[10px] text-brand-muted uppercase">Valor em Nota (R$)</label>
                            <input type="text" id="valorAquisicao" oninput="mascaraMoeda(this)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono">
                        </div>

                        <div class="p-4 bg-brand-black/30 border border-brand-gray rounded">
                            <h4 class="text-brand-orange text-xs font-bold mb-3 uppercase font-mono">Venda (Sa√≠da)</h4>
                            <label class="text-[10px] text-brand-muted uppercase">Data de Venda</label>
                            <input type="date" id="dataVenda" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white mb-2 [color-scheme:dark]">
                            <label class="text-[10px] text-brand-muted uppercase">Valor de Venda (R$)</label>
                            <input type="text" id="valorVenda" oninput="mascaraMoeda(this)" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono">
                        </div>

                        <div class="md:col-span-2 grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-brand-muted mb-1 uppercase font-bold">Taxa de Deprecia√ß√£o Anual</label>
                                <select id="tipoDepreciacao" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white">
                                    <option value="20">Ve√≠culos / Inform√°tica (20%)</option>
                                    <option value="10">M√≥veis e Utens√≠lios (10%)</option>
                                    <option value="4">Im√≥veis (4%)</option>
                                    <option value="25">Tratores / Ferramentas (25%)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-brand-muted mb-1 uppercase font-bold">Despesas com a Venda</label>
                                <input type="text" id="despesasVenda" oninput="mascaraMoeda(this)" placeholder="R$ 0,00" class="w-full bg-brand-black border border-brand-gray rounded p-2 text-white text-right font-mono">
                            </div>
                        </div>

                        <div class="md:col-span-2 border-t border-brand-gray pt-4 no-print">
                            <h3 class="text-xs font-bold text-brand-orange uppercase mb-3">Anexos Digitais (Documenta√ß√£o)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="text-[10px]"><label>NF Compra</label><input type="file" id="nfCompra" class="w-full mt-1"></div>
                                <div class="text-[10px]"><label>NF Venda</label><input type="file" id="nfVenda" class="w-full mt-1"></div>
                                <div class="text-[10px]"><label>Declara√ß√£o/Contrato</label><input type="file" id="fileDeclaracao" class="w-full mt-1"></div>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end gap-3 no-print">
                        <button onclick="limparFormulario()" class="px-4 py-2 text-sm text-brand-muted hover:text-white transition-colors">Limpar</button>
                        <button onclick="calcularSimulacao()" id="btnAcao" class="bg-brand-orange hover:bg-brand-orangeHover text-white px-8 py-3 rounded font-black shadow-lg transition-all">CALCULAR AGORA</button>
                    </div>
                </div>

                <div id="areaExplicacao" class="hidden bg-brand-dark border border-brand-info/30 rounded-lg p-6 space-y-4">
                    <h3 class="text-xl font-bold text-brand-info flex items-center gap-2 font-mono">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Entenda o C√°lculo
                    </h3>
                    <div id="passoAPasso" class="text-sm text-gray-300 leading-relaxed space-y-4">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div id="cardResultado" class="bg-brand-dark rounded-lg border border-brand-gray sticky top-24 opacity-50 pointer-events-none transition-all duration-300">
                    <div class="bg-brand-black p-4 border-b border-brand-gray">
                        <h2 class="font-bold text-white uppercase tracking-widest text-xs">Resumo da Apura√ß√£o</h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[10px] text-brand-muted uppercase">Tempo de Uso</p>
                                <p id="resTempo" class="text-lg font-bold text-white font-mono">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-brand-muted uppercase">Deprecia√ß√£o Acumulada</p>
                                <p id="resDepreciacao" class="text-lg font-bold text-brand-danger font-mono">-</p>
                            </div>
                        </div>

                        <div class="bg-brand-black p-4 rounded border border-brand-gray shadow-inner">
                            <p class="text-[10px] text-brand-muted uppercase mb-1 text-center">Valor Cont√°bil Residual</p>
                            <p id="resValorContabil" class="text-2xl font-black text-white text-center font-mono">-</p>
                        </div>

                        <div class="pt-4 border-t border-brand-gray">
                            <p class="text-[10px] text-brand-muted uppercase mb-1">Ganho de Capital (Lucro Fiscal)</p>
                            <p id="resGanho" class="text-3xl font-black text-brand-success font-mono">-</p>
                        </div>

                        <div class="p-4 bg-brand-orange/10 border-l-4 border-brand-orange rounded">
                            <p class="text-[10px] text-brand-orange font-black uppercase">Imposto Estimado</p>
                            <p id="resImposto" class="text-2xl font-black text-white font-mono">-</p>
                            <p id="resDarfInfo" class="text-[11px] text-brand-muted mt-2 italic leading-tight"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-guia" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray shadow-lg">
                    <h3 class="text-brand-orange font-black text-xl mb-4 border-b border-brand-gray pb-2 uppercase text-sm tracking-widest font-mono">Empresa COM Inscri√ß√£o Estadual (IE)</h3>
                    <p class="text-sm text-gray-300 mb-4 leading-relaxed">Mesmo sendo apenas prestadora de servi√ßos, se possuir IE ativa (ainda que isenta no faturamento de servi√ßos), a sa√≠da do bem deve ser feita via <strong>NF-e (Modelo 55)</strong>.</p>
                    
                    <div class="space-y-4">
                        <div class="bg-brand-black p-4 rounded border border-brand-gray">
                            <h4 class="text-xs font-bold text-white uppercase mb-3 tracking-tighter">Dados de Emiss√£o da Nota Fiscal</h4>
                            <ul class="text-xs space-y-3 text-brand-muted font-mono">
                                <li><strong class="text-brand-info">CFOP Intra:</strong> 5.551 (Venda de ativo dentro do estado)</li>
                                <li><strong class="text-brand-info">CFOP Inter:</strong> 6.551 (Venda de ativo fora do estado)</li>
                                <li><strong class="text-brand-info">CST ICMS:</strong> 041 (N√£o tributado)</li>
                                <li><strong class="text-brand-info">CSOSN:</strong> 400 (Simples Nacional - N√£o tributado)</li>
                                <li><strong class="text-brand-info">CST PIS/COFINS:</strong> 08 (Opera√ß√£o sem incid√™ncia)</li>
                            </ul>
                        </div>
                        <div class="bg-brand-info/10 p-4 border-l-2 border-brand-info text-[11px] text-gray-300 italic">
                            <strong>Informa√ß√µes Complementares:</strong> "N√£o incid√™ncia de ICMS conforme Artigo 7¬∫, Inciso XIV do RICMS. Opera√ß√£o de venda de ativo imobilizado."
                        </div>
                    </div>
                </div>

                <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray shadow-lg">
                    <h3 class="text-brand-success font-black text-xl mb-4 border-b border-brand-gray pb-2 uppercase text-sm tracking-widest font-mono">Empresa SEM Inscri√ß√£o Estadual</h3>
                    <p class="text-sm text-gray-300 mb-4 leading-relaxed">Empresas isentas de IE n√£o emitem NF-e de venda de mercadoria. O documento h√°bil √© a <strong>Declara√ß√£o de Venda de Ativo</strong> acompanhada da nota fiscal de origem e recibo.</p>
                    <button onclick="abrirModeloDeclaracao()" class="w-full bg-brand-gray hover:bg-brand-orange text-white py-3 rounded font-black transition-all shadow-md">GERAR MODELO DE DECLARA√á√ÉO FORMAL</button>
                    
                    <div class="mt-4 bg-brand-black p-4 rounded text-xs text-brand-muted leading-relaxed border border-brand-gray">
                        <h4 class="text-xs font-bold text-white uppercase mb-2 tracking-tighter underline">Procedimento Operacional</h4>
                        1. Emitir declara√ß√£o formal em papel timbrado.<br>
                        2. Anexar c√≥pia da nota fiscal de origem (compra).<br>
                        3. Registrar a baixa no Livro Raz√£o e planilha de imobilizados.<br>
                        4. O comprador utiliza essa declara√ß√£o para transporte e entrada.
                    </div>
                </div>
            </div>

            <div class="bg-brand-dark p-6 rounded-lg border border-brand-gray shadow-lg">
                <h3 class="text-white font-black text-xl mb-4 uppercase text-sm tracking-widest font-mono">Obriga√ß√µes Acess√≥rias e Prazos Fiscais</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="border border-brand-gray p-4 rounded bg-brand-black/20">
                        <span class="text-brand-orange font-bold text-xs uppercase tracking-tighter">Vencimento do Imposto</span>
                        <p class="text-[11px] mt-2 text-gray-300 leading-snug">O DARF (Ganho de Capital) deve ser recolhido at√© o √∫ltimo dia √∫til do <strong>m√™s subsequente</strong> ao da opera√ß√£o de venda.</p>
                    </div>
                    <div class="border border-brand-gray p-4 rounded bg-brand-black/20">
                        <span class="text-brand-orange font-bold text-xs uppercase tracking-tighter">Manuten√ß√£o Cont√°bil</span>
                        <p class="text-[11px] mt-2 text-gray-300 leading-snug">Indispens√°vel dar baixa no Ativo n√£o Circulante e interromper o c√°lculo da deprecia√ß√£o mensal na data da venda.</p>
                    </div>
                    <div class="border border-brand-gray p-4 rounded bg-brand-black/20">
                        <span class="text-brand-orange font-bold text-xs uppercase tracking-tighter">Declara√ß√µes Anuais</span>
                        <p class="text-[11px] mt-2 text-gray-300 leading-snug">O valor deve constar na <strong>DEFIS</strong> (Simples) ou na <strong>ECF</strong> (Lucro Presumido/Real) como Ganho de Capital.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-historico" class="hidden">
            <div class="bg-brand-dark rounded-lg border border-brand-gray overflow-hidden shadow-2xl">
                <div class="p-4 border-b border-brand-gray flex justify-between items-center bg-brand-black/50">
                    <h2 class="font-bold text-white text-sm uppercase tracking-widest font-mono">Arquivo de Registros & Backup</h2>
                    <div class="flex gap-2 no-print">
                        <button onclick="exportarDados()" class="text-xs bg-brand-gray px-4 py-2 rounded font-bold hover:bg-brand-orange transition-all">Download Backup (JSON)</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-brand-black text-brand-muted text-[10px] uppercase tracking-tighter">
                            <tr>
                                <th class="px-4 py-4">Empresa / Ativo</th>
                                <th class="px-4 py-4 text-right">Compra / Data / Doc</th>
                                <th class="px-4 py-4 text-right">Venda / Data / Doc</th>
                                <th class="px-4 py-4 text-right">Lucro Apurado</th>
                                <th class="px-4 py-4 text-right">Imposto (Darf/Guia)</th>
                                <th class="px-4 py-4 text-center">Gest√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaHistorico" class="divide-y divide-brand-gray/30"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalDeclaracao" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] p-4 no-print">
        <div class="bg-white text-black p-12 rounded shadow-2xl max-w-2xl w-full overflow-y-auto max-h-[90vh]">
            <div id="printArea" class="font-serif text-[12px] leading-relaxed border p-12 space-y-6">
                <h2 class="text-center text-lg font-bold underline uppercase tracking-tight">Declara√ß√£o de Venda de Ativo Imobilizado</h2>
                <p class="mt-8">A empresa <strong id="decl_empresa"></strong>, inscrita no CNPJ sob o n¬∫ <strong id="decl_cnpj">[CNPJ]</strong>, declara para os devidos fins de direito e efeitos fiscais a venda do bem abaixo descrito:</p>
                <div class="bg-gray-100 p-6 border border-black italic">
                    <p><strong>BEM:</strong> <span id="decl_bem"></span></p>
                    <p><strong>DATA DA OPERA√á√ÉO:</strong> <span id="decl_data"></span></p>
                    <p><strong>VALOR TOTAL:</strong> <span id="decl_valor"></span></p>
                </div>
                <p>A presente opera√ß√£o √© realizada com **N√ÉO INCID√äNCIA de ICMS**, por tratar-se de sa√≠da de Ativo Imobilizado integrante do patrim√¥nio da empresa, conforme prev√™ a legisla√ß√£o vigente (Artigo 7¬∫, Inciso XIV do RICMS).</p>
                <p class="mt-24 text-center">________________________________________________<br>Assinatura do Respons√°vel Legal</p>
            </div>
            <div class="mt-8 flex justify-end gap-3 no-print">
                <button onclick="document.getElementById('modalDeclaracao').classList.add('hidden')" class="px-6 py-2 bg-gray-200 rounded text-sm transition-colors hover:bg-gray-300 font-bold">Fechar</button>
                <button onclick="window.print()" class="bg-black text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition-all hover:bg-gray-800">IMPRIMIR DOCUMENTO</button>
            </div>
        </div>
    </div>

    <script>
        let historico = JSON.parse(localStorage.getItem('fiscoCap_v3')) || [];
        
        const valorParaReal = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const parseCurrency = (s) => !s ? 0 : parseFloat(s.replace(/[^\d,]/g, '').replace(',', '.'));
        
        function mascaraMoeda(i) {
            let v = i.value.replace(/\D/g, "");
            i.value = (parseFloat(v)/100 || 0).toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
        }

        function switchTab(t) {
            ['calculadora', 'guia', 'historico'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tabs-nav button').forEach(b => b.className = "pb-3 text-brand-muted hover:text-brand-orange transition-colors");
            document.getElementById(`tab-${t}`).className = "pb-3 tab-active font-bold";
            if(t === 'historico') renderHistorico();
        }

        // NOVA L√ìGICA: M√äS FECHADO (Ignora o dia da compra/venda)
        function calcularTempoMesFechado(dtIn, dtFim) {
            let [anoIn, mesIn] = dtIn.split('-').map(Number);
            let [anoFim, mesFim] = dtFim.split('-').map(Number);

            // Calcula a diferen√ßa em meses considerando o m√™s de entrada e o m√™s de sa√≠da integrais
            let totalMeses = ((anoFim - anoIn) * 12) + (mesFim - mesIn) + 1;
            
            // Prote√ß√£o caso a data final inserida seja menor que a data de entrada
            if (totalMeses < 0) totalMeses = 0; 

            let anos = Math.floor(totalMeses / 12);
            let meses = totalMeses % 12;

            return { anos, meses, totalMeses };
        }

        async function toBase64(f) {
            return new Promise(res => {
                if(!f) return res(null);
                const r = new FileReader();
                r.readAsDataURL(f);
                r.onload = () => res(r.result);
            });
        }

        async function calcularSimulacao() {
            const eid = document.getElementById('editId').value;
            const f = {
                empresa: document.getElementById('nomeEmpresa').value,
                regime: document.getElementById('regimeTributario').value,
                bem: document.getElementById('descricao').value,
                vlrAq: parseCurrency(document.getElementById('valorAquisicao').value),
                vlrVenda: parseCurrency(document.getElementById('valorVenda').value),
                despesas: parseCurrency(document.getElementById('despesasVenda').value),
                dtAq: document.getElementById('dataAquisicao').value,
                dtVenda: document.getElementById('dataVenda').value,
                taxa: parseFloat(document.getElementById('tipoDepreciacao').value)
            };

            if(!f.empresa || !f.dtAq || !f.dtVenda || f.vlrAq <= 0) { alert("Preencha os campos obrigat√≥rios."); return; }

            // Usando a nova fun√ß√£o de M√™s Fechado
            const tempo = calcularTempoMesFechado(f.dtAq, f.dtVenda);
            
            let depAc = ((f.vlrAq * (f.taxa/100)) / 12) * tempo.totalMeses;
            if(depAc > f.vlrAq) depAc = f.vlrAq;
            const vlrCont = f.vlrAq - depAc;
            const ganho = (f.vlrVenda - f.despesas) - vlrCont;
            const imposto = ganho > 0 ? (f.regime === 'simples' ? ganho * 0.15 : ganho * 0.34) : 0;
            const venc = new Date(new Date(f.dtVenda).getFullYear(), new Date(f.dtVenda).getMonth() + 2, 0);

            // Card Lateral
            document.getElementById('resTempo').innerText = `${tempo.anos} anos e ${tempo.meses} meses (Total: ${tempo.totalMeses} meses)`;
            document.getElementById('resDepreciacao').innerText = valorParaReal(depAc);
            document.getElementById('resValorContabil').innerText = valorParaReal(vlrCont);
            document.getElementById('resGanho').innerText = valorParaReal(ganho > 0 ? ganho : 0);
            document.getElementById('resImposto').innerText = valorParaReal(imposto);
            document.getElementById('resDarfInfo').innerText = `Cod: ${f.regime==='simples'?'0507':'IRPJ/CSLL'} | Venc: ${venc.toLocaleDateString('pt-BR')}`;
            document.getElementById('cardResultado').classList.replace('opacity-50', 'opacity-100');
            document.getElementById('cardResultado').classList.remove('pointer-events-none');

            // EXPLICA√á√ÉO PASSO A PASSO
            document.getElementById('areaExplicacao').classList.remove('hidden');
            document.getElementById('passoAPasso').innerHTML = `
                <p><strong>1. C√°lculo da Deprecia√ß√£o (M√™s Fechado):</strong> A Receita Federal entende que seu bem perde valor com o tempo. Para um item de <strong>${f.taxa}%/ano</strong>, ele deprecia cerca de <strong>${((f.taxa/12).toFixed(2))}% ao m√™s</strong>. Em ${tempo.totalMeses} meses inteiros contados, o bem perdeu ${valorParaReal(depAc)} do seu valor original.</p>
                <p><strong>2. O que √© Valor Cont√°bil?</strong> √â o "valor real" do bem para o fisco hoje. <br>
                <span class="text-white italic">F√≥rmula: Valor Compra (${valorParaReal(f.vlrAq)}) - Deprecia√ß√£o Acumulada (${valorParaReal(depAc)}) = <strong class="text-brand-orange">${valorParaReal(vlrCont)}</strong>.</span><br>
                Este √© o valor que a Receita Federal estima que o bem vale no seu balan√ßo no momento da venda.</p>
                <div class="bg-brand-black/50 p-4 border-l-4 border-brand-info rounded shadow-md">
                    <p><strong>3. An√°lise Fiscal do Ganho:</strong> Pelo seu bem ter sido vendido acima do valor que a Receita Federal esperava (${valorParaReal(vlrCont)}), eles exigem que voc√™ pague imposto sobre o <strong>Ganho de Capital</strong>. No caso, voc√™ ganhou <strong>${valorParaReal(ganho > 0 ? ganho : 0)}</strong> sobre essa venda, pois a receita esperava uma venda de valor menor.</p>
                </div>
                <p class="text-[11px] text-brand-muted italic mt-2">O imposto incide sobre este ganho l√≠quido porque a opera√ß√£o gerou um acr√©scimo patrimonial tribut√°vel.</p>
            `;

            // Processamento de Backup e Arquivos
            const ant = eid ? historico.find(i => i.id == eid) : null;
            const novo = {
                ...f, id: eid ? parseInt(eid) : Date.now(), 
                ganho, imposto, tempoStr: `${tempo.anos} anos e ${tempo.meses} meses`, 
                venc: venc.toLocaleDateString('pt-BR'), code: f.regime === 'simples' ? "0507" : "IRPJ/CSLL",
                docC: await toBase64(document.getElementById('nfCompra').files[0]) || (ant?ant.docC:null),
                docV: await toBase64(document.getElementById('nfVenda').files[0]) || (ant?ant.docV:null),
                docD: await toBase64(document.getElementById('fileDeclaracao').files[0]) || (ant?ant.docD:null),
                docI: ant ? ant.docI : null
            };

            const idx = historico.findIndex(i => i.id == novo.id);
            if(idx >= 0) historico[idx] = novo; else historico.push(novo);
            localStorage.setItem('fiscoCap_v3', JSON.stringify(historico));
            
            if(eid) { alert("Altera√ß√£o salva com sucesso!"); limparFormulario(); switchTab('historico'); }
        }

        function renderHistorico() {
            const body = document.getElementById('tabelaHistorico');
            body.innerHTML = historico.map(i => {
                const dC = i.dtAq.split('-').reverse().join('/');
                const dV = i.dtVenda.split('-').reverse().join('/');
                return `
                <tr class="hover:bg-brand-dark/50 border-b border-brand-gray/50 align-top transition-colors">
                    <td class="px-4 py-6"><div class="font-bold text-white text-base">${i.empresa}</div><div class="text-[10px] text-brand-muted uppercase tracking-tighter">${i.bem}</div>
                        ${i.docD ? `<a href="${i.docD}" download="Declara√ß√£o" class="text-[9px] text-brand-info underline block mt-2 font-bold tracking-tighter">üìÑ VER DECLARA√á√ÉO</a>` : ''}
                    </td>
                    <td class="px-4 py-6 text-right">
                        <div class="font-mono text-white font-bold text-sm">${valorParaReal(i.vlrAq)}</div>
                        <div class="text-[10px] text-brand-muted font-mono">${dC}</div>
                        ${i.docC ? `<a href="${i.docC}" download="NF_Compra" class="text-[9px] text-brand-orange underline block mt-2 font-bold tracking-tighter">üì• NF COMPRA</a>` : ''}
                    </td>
                    <td class="px-4 py-6 text-right">
                        <div class="font-mono text-white font-bold text-sm">${valorParaReal(i.vlrVenda)}</div>
                        <div class="text-[10px] text-brand-muted font-mono">${dV}</div>
                        ${i.docV ? `<a href="${i.docV}" download="NF_Venda" class="text-[9px] text-brand-orange underline block mt-2 font-bold tracking-tighter">üì• NF VENDA</a>` : ''}
                    </td>
                    <td class="px-4 py-6 text-right font-black text-brand-success font-mono text-sm">${valorParaReal(i.ganho > 0 ? i.ganho : 0)}</td>
                    <td class="px-4 py-6 text-right">
                        <div class="font-mono font-black text-brand-danger text-sm">${valorParaReal(i.imposto)}</div>
                        <div class="text-[8px] text-brand-muted uppercase leading-tight">Cod: ${i.code}<br>Venc: ${i.venc}</div>
                        <div class="mt-3 flex flex-col items-end gap-1">
                            <input type="file" id="upI_${i.id}" class="hidden" onchange="anexarGuia(${i.id})">
                            <button onclick="document.getElementById('upI_${i.id}').click()" class="text-[9px] border border-brand-gray px-3 py-1 rounded text-white hover:bg-brand-orange transition-all font-bold">ANEXAR GUIA PAGA</button>
                            ${i.docI ? `<a href="${i.docI}" download="Guia_Paga" class="text-[9px] text-brand-success font-black underline tracking-tight">‚úÖ VER GUIA SALVA</a>` : ''}
                        </div>
                    </td>
                    <td class="px-4 py-6 text-center">
                        <div class="flex flex-col gap-3 items-center">
                            <button onclick="carregarEdicao(${i.id})" class="text-brand-info hover:scale-125 transition-transform">‚úé</button>
                            <button onclick="excluir(${i.id})" class="text-brand-danger hover:scale-125 transition-transform">‚úï</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        async function anexarGuia(id) {
            const f = document.getElementById(`upI_${id}`).files[0];
            if(f) {
                const b64 = await toBase64(f);
                const idx = historico.findIndex(i => i.id == id);
                historico[idx].docI = b64;
                localStorage.setItem('fiscoCap_v3', JSON.stringify(historico));
                renderHistorico();
                alert("Guia de imposto arquivada no hist√≥rico!");
            }
        }

        function carregarEdicao(id) {
            const item = historico.find(i => i.id == id);
            document.getElementById('editId').value = item.id;
            document.getElementById('nomeEmpresa').value = item.empresa;
            document.getElementById('descricao').value = item.bem;
            document.getElementById('dataAquisicao').value = item.dtAq;
            document.getElementById('dataVenda').value = item.dtVenda;
            document.getElementById('regimeTributario').value = item.regime;
            document.getElementById('tipoDepreciacao').value = item.taxa;
            
            const vA = document.getElementById('valorAquisicao'); vA.value=(item.vlrAq*100).toFixed(0); mascaraMoeda(vA);
            const vV = document.getElementById('valorVenda'); vV.value=(item.vlrVenda*100).toFixed(0); mascaraMoeda(vV);
            const vD = document.getElementById('despesasVenda'); vD.value=(item.despesas*100).toFixed(0); mascaraMoeda(vD);

            const btn = document.getElementById('btnAcao');
            btn.innerText = "SALVAR ALTERA√á√ïES NO REGISTRO";
            btn.classList.replace('bg-brand-orange', 'bg-brand-success');
            document.getElementById('editModeIndicator').classList.remove('hidden');
            switchTab('calculadora');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function limparFormulario() {
            document.getElementById('calcForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('editModeIndicator').classList.add('hidden');
            document.getElementById('cardResultado').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('btnAcao').innerText = "CALCULAR AGORA";
            document.getElementById('btnAcao').classList.replace('bg-brand-success', 'bg-brand-orange');
            document.getElementById('areaExplicacao').classList.add('hidden');
        }

        function abrirModeloDeclaracao() {
            document.getElementById('decl_empresa').innerText = document.getElementById('nomeEmpresa').value || "[Raz√£o Social]";
            document.getElementById('decl_bem').innerText = document.getElementById('descricao').value || "[Descri√ß√£o do Ativo]";
            document.getElementById('decl_data').innerText = document.getElementById('dataVenda').value ? new Date(document.getElementById('dataVenda').value).toLocaleDateString('pt-BR') : "[Data]";
            document.getElementById('decl_valor').innerText = document.getElementById('valorVenda').value || "R$ 0,00";
            document.getElementById('modalDeclaracao').classList.remove('hidden');
            document.getElementById('modalDeclaracao').classList.add('flex');
        }

        function excluir(id) { if(confirm("Tem certeza que deseja remover este registro permanentemente?")) { historico = historico.filter(i => i.id != id); localStorage.setItem('fiscoCap_v3', JSON.stringify(historico)); renderHistorico(); } }
        function exportarDados() { const b = new Blob([JSON.stringify(historico)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='fisco_capital_backup.json'; a.click(); }
    </script>
</body>
</html>
