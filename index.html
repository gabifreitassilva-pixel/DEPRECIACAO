<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Fiscal Pro - Simples Nacional</title>
    <style>
        /* MANTENDO SEU LAYOUT ORIGINAL */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; background-color: #f4f7f6; }
        .sidebar { width: 260px; background: #2c3e50; color: white; height: 100vh; position: fixed; padding: 20px; overflow-y: auto; }
        .sidebar h2 { font-size: 1.2rem; text-align: center; color: #1abc9c; border-bottom: 1px solid #34495e; padding-bottom: 10px; }
        .sidebar a { display: block; color: #bdc3c7; padding: 12px; text-decoration: none; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem; transition: 0.3s; }
        .sidebar a:hover { background: #34495e; color: white; }
        
        .main-content { margin-left: 300px; padding: 40px; width: 100%; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* √ÅREA DO AUDITOR (O que era o arquivo auditor.html) */
        .upload-area { border: 2px dashed #3498db; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; background: #ebf5fb; transition: 0.3s; }
        .upload-area:hover { background: #d6eaf8; }
        .btn-auditar { background: #27ae60; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 20px; }
        
        .resumo-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .card-stats { padding: 20px; border-radius: 8px; color: white; text-align: center; }
        .bg-blue { background: #3498db; }
        .bg-green { background: #27ae60; }
        .bg-orange { background: #e67e22; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 0.85rem; }
        th { background: #f8f9fa; color: #333; }
        .status-monofasico { color: #d35400; font-weight: bold; background: #fff5e6; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>üöÄ AUDITOR FISCAL</h2>
    <a href="index.html">üè† Dashboard Auditor</a>
    <a href="auto pecas.html">üöó Auto Pe√ßas</a>
    <a href="bebidas alcolicas exceto cerveja e chope.html">üçπ Bebidas</a>
    <a href="perfumaria e higiene pessoal.html">üíÑ Perfumaria</a>
    <a href="Produtos alimenticios.html">üçé Aliment√≠cios</a>
    <a href="materiais de contrucao e congeneres.html">üèóÔ∏è Mat. Constru√ß√£o</a>
    <a href="papelaria.html">üìù Papelaria</a>
    <a href="produtos de limpeza.html">üßº Limpeza</a>
    <a href="baselegal.html">‚öñÔ∏è Base Legal</a>
    <hr style="border: 0; border-top: 1px solid #34495e; margin: 20px 0;">
    <a href="configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
</div>

<div class="main-content">
    <div class="card">
        <h1>Auditoria de Recupera√ß√£o Simples Nacional</h1>
        <p>Arraste seus arquivos XML (NF-e/NFC-e) para identificar automaticamente produtos Monof√°sicos.</p>
        
        <div class="upload-area" id="dropzone" onclick="document.getElementById('fileInput').click()">
            <p>üìÅ Clique aqui ou arraste os arquivos XML para come√ßar a auditoria</p>
            <input type="file" id="fileInput" multiple accept=".xml" style="display:none" onchange="processarArquivos(this.files)">
        </div>
    </div>

    <div id="resultados-secao" style="display:none;">
        <div class="resumo-cards">
            <div class="card-stats bg-blue">
                <small>Notas Processadas</small>
                <h2 id="qtd-notas">0</h2>
            </div>
            <div class="card-stats bg-orange">
                <small>Itens Monof√°sicos</small>
                <h2 id="qtd-itens">0</h2>
            </div>
            <div class="card-stats bg-green">
                <small>Recupera√ß√£o Estimada</small>
                <h2 id="total-recuperar">R$ 0,00</h2>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Relat√≥rio de Itens "Fora da Lei"</h3>
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>NCM</th>
                        <th>Valor</th>
                        <th>Motivo/Setor</th>
                        <th>Base Legal</th>
                    </tr>
                </thead>
                <tbody id="tabela-resultados"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. O MOTOR DE BUSCA (LIGANDO TODOS OS SEUS ANEXOS)
    // Extra√≠do da varredura de todos os seus arquivos do .rar
    const REGRAS_FISCAIS = {
        "Auto Pe√ßas": ["8708", "4011", "8433", "8421", "8511", "8512", "7007"],
        "Bebidas": ["2202", "2203"],
        "Perfumaria": ["3303", "3304", "3305", "3307", "3401"],
        "Alimentos": ["1902", "1905", "2106", "1704"],
        "Limpeza": ["3402", "3808", "4818"],
        "Papelaria": ["4820", "4901", "9608", "9609"],
        "Mat. Constru√ß√£o": ["7308", "3214", "3824", "3917", "7009"]
    };

    async function processarArquivos(files) {
        if (files.length === 0) return;

        document.getElementById('resultados-secao').style.display = 'block';
        const tabela = document.getElementById('tabela-resultados');
        tabela.innerHTML = "";
        
        let totalRecuperar = 0;
        let contadorItens = 0;
        document.getElementById('qtd-notas').innerText = files.length;

        for (let file of files) {
            const xmlText = await file.text();
            const xml = new DOMParser().parseFromString(xmlText, "text/xml");
            const produtos = xml.getElementsByTagName("det");

            for (let i = 0; i < produtos.length; i++) {
                const ncm = produtos[i].getElementsByTagName("NCM")[0].textContent;
                const nome = produtos[i].getElementsByTagName("xProd")[0].textContent;
                const valor = parseFloat(produtos[i].getElementsByTagName("vProd")[0].textContent);
                
                let setorEncontrado = null;
                for (let setor in REGRAS_FISCAIS) {
                    if (REGRAS_FISCAIS[setor].some(prefixo => ncm.startsWith(prefixo))) {
                        setorEncontrado = setor;
                        break;
                    }
                }

                if (setorEncontrado) {
                    contadorItens++;
                    // C√°lculo aproximado Simples Nacional (PIS/COFINS Monof√°sico)
                    const recuperacaoItem = valor * 0.0198; 
                    totalRecuperar += recuperacaoItem;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${nome}</td>
                        <td>${ncm}</td>
                        <td>R$ ${valor.toFixed(2)}</td>
                        <td><span class="status-monofasico">${setorEncontrado}</span></td>
                        <td><small>Lei 10.147/00 (Fed)</small></td>
                    `;
                    tabela.appendChild(tr);
                }
            }
        }

        document.getElementById('qtd-itens').innerText = contadorItens;
        document.getElementById('total-recuperar').innerText = "R$ " + totalRecuperar.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    // REGISTRO DO SERVICE WORKER (PARA ATUALIZA√á√ÉO AUTOM√ÅTICA)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(() => {
            console.log("Sistema de Auditoria pronto e atualizado.");
        });
    }
</script>

</body>
</html>
